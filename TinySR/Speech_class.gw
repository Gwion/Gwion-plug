#import TinySr

class global Speech extends TinySR {
  var private int _try;
  if(me.args())
    Std.atoi(me.arg(0)) :=> _try;

  fun int load(const string model, const string path) {
    model => (this $ TinySR).load :=> const int loaded;
    if(loaded == -1) {
      <<<"failed to load ", model, ".">>>;
      me.exit();
    } 
    path => check;
    if(!_try)
      <<<"loaded ", loaded, " words from ", model, ".">>>;
    else
       <<<"(after ", _try, " tries)">>>;
    for(var int i; i < loaded; ++i)
      <<<"  * ", word(i)>>>;
    return loaded;
  }

  fun void check(const string path) {
    .5::second => now;
    if(state()) {
      ++_try :=> var string n;
      Machine.add(path + ":" + n);
      me.exit();
    }
  } 

  fun void loop(const float seuil) {
    while(ev => now) {
      if(score > seuil)
        <<<word(), " (", score, ")">>>;
    }
  }
}
